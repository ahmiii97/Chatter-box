<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatterbox - Messages</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="chat-app">
        <!-- Sidebar with contacts -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <button id="logout-btn">Logout</button>
            </div>
            
            <div class="search-container">
                <input type="text" id="user-search" placeholder="Search users by email...">
                <button onclick="searchUser()">Search</button>
            </div>
            
            <div class="contacts-list" id="contacts-list">
                <!-- Contacts will be loaded here -->
            </div>
        </div>

        <!-- Main chat area -->
        <div class="chat-area">
            <div class="chat-header" id="chat-header">
                <div class="select-user-prompt">
                    <h3>Select a user to start chatting</h3>
                </div>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <!-- Messages will be displayed here -->
            </div>
            
            <div class="chat-input-container">
                <input type="text" id="message-input" placeholder="Type a message..." disabled>
                <button id="send-btn" disabled>Send</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io('http://localhost:5000');
        let currentUser = null;
        let selectedContact = null;
        const token = localStorage.getItem('chatToken');
        const userData = JSON.parse(localStorage.getItem('user'));

        // Check authentication
        if (!token || !userData) {
            window.location.href = '/';
        }

        // Authenticate with socket
        socket.emit('authenticate', token);

        // Socket event listeners
        socket.on('new_message', (data) => {
            if (selectedContact && data.from === selectedContact.id) {
                addMessage(data.text, 'received');
            }
        });

        socket.on('message_sent', (data) => {
            if (selectedContact && data.to === selectedContact.id) {
                addMessage(data.text, 'sent');
            }
        });

        // DOM elements
        const contactsList = document.getElementById('contacts-list');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const chatHeader = document.getElementById('chat-header');
        const userSearch = document.getElementById('user-search');
        const logoutBtn = document.getElementById('logout-btn');

        // Logout functionality
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('chatToken');
            localStorage.removeItem('user');
            window.location.href = '/';
        });

        // Search for users
        async function searchUser() {
            const email = userSearch.value.trim();
            if (!email) return;

            try {
                const response = await fetch(`/api/users/search?email=${encodeURIComponent(email)}&token=${token}`);
                const user = await response.json();
                
                if (user && user.id !== userData.uid) {
                    addContact(user);
                    userSearch.value = '';
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        // Add contact to list
        function addContact(user) {
            const contactElement = document.createElement('div');
            contactElement.className = 'contact';
            contactElement.innerHTML = `
                <div class="contact-info">
                    <h4>${user.displayName || user.email}</h4>
                    <p>${user.email}</p>
                </div>
            `;
            
            contactElement.addEventListener('click', () => {
                selectContact(user);
            });
            
            contactsList.appendChild(contactElement);
        }

        // Select contact to chat with
        function selectContact(user) {
            selectedContact = user;
            chatHeader.innerHTML = `
                <div class="chat-with">
                    <h3>${user.displayName || user.email}</h3>
                    <p>Online</p>
                </div>
            `;
            
            chatMessages.innerHTML = '';
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
            
            // Load previous messages (you can implement this)
        }

        // Send message
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !selectedContact) return;

            socket.emit('private_message', {
                to: selectedContact.id,
                text: text
            });

            messageInput.value = '';
        }

        // Add message to chat
        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Load user's contacts (you can implement this)
    </script>
</body>
</html>